<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DFO Gear Tracker</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="navbar">
    <img src="assets/image/ch49gang.png" alt="Logo">
    <div class="nav-buttons">
      <a href="#">Gear Viewer</a>
      <a href="#">Fame Tracker</a>
      <a href="#">Rankings</a>
    </div>
  </div>
  <div class="main">
    <div class="logo">DFO Gear Tracker</div>
    <div class="search-box">
      <select>
        <option>All Servers</option>
        <option>Cain</option>
        <option>Sirocco</option>
      </select>
      <input type="text" placeholder="Character, Adventurer, or Guild Name">
      <button>SEARCH</button>
    </div>
    <div id="results"></div>
  </div>

<script>
    function serverToApiValue(s) {
    // 'Sirocco' => 'siroco', 'Cain' => 'cain'
    if (s.toLowerCase() === "sirocco") return "siroco";
    return s.toLowerCase();
    }
    function showCard(profile, explorerName) {
    const spritePath = `assets/characters/${profile.jobName}.png`;
    return `
        <div class="card" style="cursor:pointer">
        <img src="${spritePath}" alt="${profile.jobName}" style="width:200px;height:230px;object-fit:contain;margin-bottom:12px;border-radius:10px;background:#191919;box-shadow:0 1px 4px #0004;">
        <div style="color:#7db88a;font-size:1.08em;font-weight:600;margin-bottom:2px;">${explorerName ?? '-'}</div>
        <div class="card-title" style="color:#b6aa8f;font-size:2.05em;font-weight:800;margin-bottom:5px;line-height:1.1;">${profile.characterName ?? '-'}</div>
        <div style="color:#A0844B;font-size:1.02em;margin-bottom:12px;letter-spacing:0.2px;">[${profile.jobGrowName ?? '-'}]</div>
        <div style="display:flex;align-items:center;justify-content:center;margin-top:4px;">
            <img src="assets/image/fame.png" alt="Fame" style="width:15px;height:13px;vertical-align:middle;margin-right:7px;">
            <span style="color:#3ba042;font-size:1.12em;font-weight:bold;letter-spacing:1px;">${profile.fame ?? '-'}</span>
        </div>
        </div>
    `;
    }

    document.querySelector('button').addEventListener('click', async function() {
    const serverSel = document.querySelector('select').value;
    const explorerName = document.querySelector('input').value.trim();
    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = "";

    if (!explorerName) {
        alert("Please enter a name!");
        return;
    }
    if (serverSel === "All Servers") {
        resultsDiv.innerHTML = `<div style="color:#f66; font-weight:bold;">Please select a server.</div>`;
        return;
    }

    const serverId = serverToApiValue(serverSel);

    try {
        // Flask /search POST 요청
        const res = await fetch('/search', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({server: serverId, name: explorerName})
        });
        if (!res.ok) throw new Error("Not found");
        const data = await res.json();
        const characterId = data.characterId;
        const profile = data.profile;

        resultsDiv.innerHTML = showCard(profile, explorerName);

        // 카드 클릭시 /equipment 요청
        const cardElem = document.querySelector('.card');
        cardElem.addEventListener('click', async () => {
        try {
            const eqRes = await fetch('/equipment', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({server: serverId, name: explorerName})
            });
            if (!eqRes.ok) throw new Error("Equipment error");
            const eqData = await eqRes.json();
            alert(eqData.changed
            ? "Equipment updated!\n(변동 있음, history 갱신됨)"
            : "No change in equipment.\n(장비 변동 없음)");
            // 콘솔에 장비 데이터 찍기
            console.log(eqData.equipment);
        } catch(e) {
            alert("장비 정보 불러오기/저장에 실패했습니다.");
        }
        });

    } catch (e) {
        resultsDiv.innerHTML =
        `<div style="color:#f66; font-weight:bold;">Character info not found.</div>`;
    }
    });
</script>


</body>
</html>
