<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DFO Gear Tracker</title>
    <link rel="stylesheet" href="style.css" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
        }

        .navbar {
            display: flex;
            align-items: center;
            background-color: #1f1f1f;
            padding: 10px 20px;
            border-bottom: 1px solid #333;
        }

        .navbar img {
            width: 32px;
            height: 32px;
            margin-right: 20px;
        }

        .nav-buttons {
            display: flex;
            gap: 20px;
        }

        .nav-buttons a {
            color: #e0e0e0;
            text-decoration: none;
            font-weight: bold;
        }

        .main {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        #detail-view {
            padding: 20px;
        }

        .character-detail {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .character-canvas {
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.4);
            /* ‚úÖ ÏÜåÌîÑÌä∏ Í∑∏Î¶ºÏûê */
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            width: 400px;
            height: 300px;
        }

        .character-canvas img.background {
            width: 100%;
            height: 100%;
            position: absolute;
            z-index: 0;
        }

        .character-sprite {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            height: 250px;
            z-index: 1;
        }

        .equipment-layer {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 2;
        }

        .top-center,
        .bottom-left,
        .bottom-right {
            background-color: #1a1a1a;
            border: 1px solid #444;
            padding: 10px;
            color: #aaa;
        }

        .top-center {
            grid-area: top-center;
        }

        .bottom-left {
            grid-area: bottom-left;
        }

        .bottom-right {
            grid-area: bottom-right;
        }

        .character-canvas {
            position: relative;
            width: calc(246px * 2);
            height: calc(177px * 2);
        }

        .character-canvas img.background {
            width: 100%;
            height: 100%;
            position: absolute;
            z-index: 0;
        }

        .character-sprite {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            height: 250px;
            /* Í∑∏ÎåÄÎ°ú Ïú†ÏßÄ */
            z-index: 1;
        }

        .equipment-layer {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 2;
        }

        .equipment-icon {
            position: absolute;
            /* ÌÅ¨Í∏∞ JSÏóêÏÑú ÏßÄÏ†ï */
        }

        .tune-icon {
            position: absolute;
            z-index: 3;
        }
    </style>
</head>

<body>
    <div class="navbar">
        <img src="assets/image/ch49gang.png" alt="Logo" />
        <div class="nav-buttons">
            <a href="#">Gear Viewer</a>
            <a href="#">Fame Tracker</a>
            <a href="#">Rankings</a>
        </div>
    </div>

    <div class="main" id="main-view">
        <div class="logo">DFO Gear Tracker</div>
        <div class="search-box">
            <select>
                <option>Cain</option>
                <option>Sirocco</option>
                <option>All Servers</option>
            </select>
            <input type="text" placeholder="Character, Adventurer, or Guild Name" />
            <button>SEARCH</button>
        </div>
        <div id="results"></div>
    </div>

    <div id="detail-view" style="display:none;"></div>

    <script>
        const API_ROOT = "http://localhost:5000";

        const SLOT_POSITION = {
            HeadShoulder: [7, 8],
            Top: [39, 8],
            Bottom: [7, 40],
            Belt: [39, 40],
            Shoes: [7, 72],
            Weapon: [181, 8],
            SecondaryWeapon: [165, 6],
            Title: [213, 8],
            Bracelet: [181, 40],
            Necklace: [213, 40],
            Ring: [213, 72],
            SubEquipment: [181, 72],
            Earrings: [181, 104],
            MagicStone: [213, 104]
        };

        function normalizeSlot(slot) {
            return slot.replace(/[\s\/]/g, "");
        }

        function serverToApiValue(s) {
            if (s.toLowerCase() === "sirocco") return "siroco";
            return s.toLowerCase();
        }

        function serverToRealValue(s) {
            if (s.toLowerCase() === "siroco") return "Siroco";
            return "Cain";
        }

        function showCard(profile, explorerName) {
            const spritePath = `assets/characters/${profile.jobName}.png`;
            return `
                <div class="card" style="cursor:pointer;display: flex; flex-direction: column;align-items: center; justify-content: center;text-align: center; position: relative;">
                
                <!-- Server ID & Fame (Top-Right, no background) -->
                <div style="position: absolute; top: 10px; right: 10px; display: flex; flex-direction: column; align-items: flex-end;margin-right:10px;margin-top:5px">
                    <div style="font-size: 0.75em; font-weight: 500; color:#d2d2d2;">
                    ${serverToRealValue(profile.serverId) ?? '-'}
                    </div>
                    <div style="display:flex;align-items:center;justify-content:flex-end;margin-top:4px;">
                    <img src="assets/image/fame.png" alt="Fame" style="width:15px;height:13px;vertical-align:middle;margin-right:4px;margin-top:3px">
                    <span style="color:#3ba042;font-size:0.8em;letter-spacing:1px;">${profile.fame ?? '-'}</span>
                    </div>
                </div>

                <!-- Character Sprite -->
                <img src="${spritePath}" alt="${profile.jobName}" style="width:200px;height:230px;object-fit:contain;margin-bottom:12px;border-radius:10px;">

                <!-- Explorer Name -->
                <div style="color:#7db88a;font-size:0.8em;font-weight:400;">${profile.adventureName ?? '-'}</div>

                <!-- Character Name -->
                <div class="card-title" style="color:#eee;font-size:1.8em;font-weight:600;line-height:1.1;">${profile.characterName ?? '-'}</div>

                <!-- Job Grow Name -->
                <div style="color:#A0844B;font-size:0.8em;margin-bottom:12px;letter-spacing:0.2px;">[${profile.jobGrowName ?? '-'}]</div>
                </div>
            `;
        }



        const SCALE = 2.0;
        async function drawCharacterText(ctx, profile) {
            const font = new FontFace("GulimIndex", "url(font/gulim_index_2.ttf)");
            await font.load();
            document.fonts.add(font);

            ctx.font = `${10 * SCALE}px GulimIndex`;
            ctx.textAlign = "center";
            ctx.textBaseline = "top";

            const centerX = ctx.canvas.width / 2;
            const firstline = 124 * SCALE;
            const linespacing = 12 * SCALE;

            function drawTextWithOutline(text, y, color) {
                ctx.lineWidth = 4.5;
                ctx.strokeStyle = "black";
                ctx.strokeText(text, centerX, y);
                ctx.fillStyle = color;
                ctx.fillText(text, centerX, y);
            }

            drawTextWithOutline(profile.explorerName ?? profile.adventureName ?? '-', firstline, "#7db88a");
            drawTextWithOutline(`Lv.${profile.level} ${profile.characterName}`, firstline + linespacing, "#b6aa8f");
            drawTextWithOutline(`[${profile.jobGrowName}]`, firstline + linespacing * 2, "#A0844B");

            // Fame Íµ¨ÏÑ± (ÏïÑÏù¥ÏΩò + ÌÖçÏä§Ìä∏Î•º Ìïú Îç©Ïñ¥Î¶¨Î°ú Ï§ëÏïô Ï†ïÎ†¨)
            const fameText = profile.fame?.toString() ?? '-';
            const fameY = firstline + linespacing * 3;
            const iconW = 15 * SCALE * 0.75;
            const iconH = 13 * SCALE * 0.75;
            const padding = 3 * SCALE;

            const fameIcon = new Image();
            fameIcon.src = "assets/image/fame.png";
            fameIcon.onload = () => {
                const textMetrics = ctx.measureText(fameText);
                const textWidth = textMetrics.width;
                const textHeight = textMetrics.actualBoundingBoxAscent + textMetrics.actualBoundingBoxDescent;

                const totalWidth = iconW + padding + textWidth;
                const startX = (ctx.canvas.width - totalWidth) / 2;
                const textX = startX + iconW + padding;

                // ‚úÖ Ï§ëÏã¨ ÎßûÏ∂§ Î≥¥Ï†ï
                const visualYOffset = 2 * SCALE;
                const textCenterY = fameY + textHeight / 2 + visualYOffset;
                const iconY = textCenterY - iconH / 2;

                ctx.drawImage(fameIcon, startX, iconY, iconW, iconH);

                // ÌÖçÏä§Ìä∏Îäî ÏôºÏ™Ω Ï†ïÎ†¨Î°ú Ï†ïÌôïÌûà ÏïÑÏù¥ÏΩò Ïò§Î•∏Ï™ΩÏóê ÏúÑÏπò
                ctx.textAlign = "left";
                ctx.lineWidth = 3;
                ctx.strokeStyle = "black";
                ctx.strokeText(fameText, textX, fameY);
                ctx.fillStyle = "#3ba042";
                ctx.fillText(fameText, textX, fameY);

                ctx.textAlign = "center"; // Î≥µÏõê
            };
        }

        function renderFameChart(records, hoverX = null, hoverY = null) {
            const canvas = document.getElementById("fame-chart");
            const ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // === ‚öôÔ∏è STYLE CONFIG ===================
            const axisColor = "#48bfe3";
            const gridColor = "rgba(72,191,240,0.1)";
            const dotColor = "#4cc9f0";     // Ï†ê: ÏïΩÍ∞Ñ Îçî Î∞ùÏùÄ Î∏îÎ£®
            const lineColor = "#4cc9f0";
            const tooltipBg = "rgba(0, 0, 0, 0.85)";
            const tooltipBorder = "#4cc9f0";
            const textColor = "#ffffff";
            const labelFont = `11px 'Noto Sans KR', sans-serif`;
            const labelColor = "#eee";
            const tooltipFont = `bold 11px 'Noto Sans KR', sans-serif`;
            const dotRadius = 4;

            const paddingX = 40;
            const paddingY = 30;

            if (!records || records.length === 0) {
                ctx.fillStyle = "#aaa";
                ctx.font = labelFont;
                ctx.textAlign = "center";
                ctx.fillText("No fame history", canvas.width / 2, canvas.height / 2);
                return;
            }

            // === üìä DATA ===================
            records.sort((a, b) => new Date(a.date) - new Date(b.date));
            const fames = records.map(r => r.fame);
            const dates = records.map(r => new Date(r.date));

            const rawFameMin = Math.min(...fames);
            const rawFameMax = Math.max(...fames);

            let fameMin, fameMax;
            if (rawFameMin === rawFameMax) {
                // ‚úÖ Ìïú Ï†êÏùº Í≤ΩÏö∞ Í∞ïÏ†úÎ°ú Ïó¨Ïú† Î≤îÏúÑ Î∂ÄÏó¨
                fameMin = rawFameMin - 200;
                fameMax = rawFameMax + 200;
            } else {
                const famePadding = (rawFameMax - rawFameMin) * 0.15;
                fameMin = rawFameMin - famePadding;
                fameMax = rawFameMax + famePadding;
            }
            const fameRange = fameMax - fameMin;



            const chartWidth = canvas.width - paddingX * 2;
            const chartHeight = canvas.height - paddingY * 2;

            const paddingRatio = 0; // ÏñëÏ™Ω Ïó¨Î∞±
            const domainMin = -paddingRatio;
            const domainMax = 1 + paddingRatio;
            const domainRange = domainMax - domainMin;

            const points = records.map((r, i) => {
                const t = records.length === 1 ? 0.5 : i / (records.length - 1);
                const normalizedT = (t - domainMin) / domainRange;
                const x = paddingX + normalizedT * chartWidth;

                const y = (records.length === 1)
                    ? canvas.height / 2
                    : paddingY + (1 - (r.fame - fameMin) / fameRange) * chartHeight;

                return { x, y, fame: r.fame, date: r.date };
            });




            // === üß± GRID ===================
            ctx.font = labelFont;
            ctx.textAlign = "right";
            ctx.textBaseline = "middle";

            // üéØ ÎùºÎ≤® Í∞ÑÍ≤© ÎèôÏ†Å Í≥ÑÏÇ∞
            const step = fameRange < 3000 ? 200 : 1000;

            // üéØ ÏãúÏûë ÎùºÎ≤®: step Îã®ÏúÑÎ°ú Îî± ÎÇòÎàÑÏñ¥ÏßÄÎäî Ïà´ÏûêÎ°ú ÎÇ¥Î¶º
            const firstLabel = Math.floor(fameMin / step) * step;
            const lastLabel = Math.ceil(fameMax / step) * step;

            for (let value = firstLabel; value <= lastLabel; value += step) {
                // üéØ Ïã§Ï†ú Í∑∏ÎûòÌîÑ Î≤îÏúÑ ÎÇ¥ÏóêÏÑúÎßå Í∑∏Î¶¨Í∏∞
                if (value < fameMin || value > fameMax) continue;

                const y = paddingY + (1 - (value - fameMin) / fameRange) * chartHeight;

                // Î≥¥Ï°∞ÏÑ†
                ctx.strokeStyle = gridColor;
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(paddingX, y);
                ctx.lineTo(canvas.width - paddingX, y);
                ctx.stroke();

                // ÎùºÎ≤®
                ctx.fillStyle = labelColor;
                ctx.fillText(value.toLocaleString(), paddingX - 6, y);
            }


            // ‚úÖ YÏ∂ï Ï∂ïÏÑ† Ï∂îÍ∞Ä
            ctx.strokeStyle = axisColor;
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(paddingX, paddingY);
            ctx.lineTo(paddingX, canvas.height - paddingY);
            ctx.stroke();
            // ‚úÖ XÏ∂ï Ï∂ïÏÑ† Ï∂îÍ∞Ä
            ctx.strokeStyle = axisColor;
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(paddingX, canvas.height - paddingY);
            ctx.lineTo(canvas.width - paddingX, canvas.height - paddingY);
            ctx.stroke();

            // === üìÖ X-axis dates ===================
            ctx.font = labelFont;  // ‚úÖ Î∞òÎìúÏãú Îã§Ïãú ÏÑ§Ï†ï!
            ctx.textAlign = "center";
            ctx.textBaseline = "top";
            for (let i = 0; i < points.length; i++) {
                const pt = points[i];
                const d = new Date(pt.date);
                const label = `${String(d.getMonth() + 1).padStart(2, "0")}/${String(d.getDate()).padStart(2, "0")}`;
                ctx.fillStyle = labelColor; // üéØ ÎùºÎ≤® ÏÉâÏÉÅ ÏßÄÏ†ï
                ctx.fillText(label, pt.x, canvas.height - paddingY + 4);
            }

            // === üìà Line ===================
            ctx.strokeStyle = lineColor;
            ctx.lineWidth = 4;
            ctx.beginPath();
            points.forEach((pt, i) => {
                if (i === 0) ctx.moveTo(pt.x, pt.y);
                else ctx.lineTo(pt.x, pt.y);
            });
            ctx.stroke();

            // === üü¢ Dots ===================
            let hovered = null;
            points.forEach(pt => {
                ctx.beginPath();
                ctx.arc(pt.x, pt.y, dotRadius, 0, 2 * Math.PI);
                ctx.fillStyle = dotColor;
                ctx.shadowColor = dotColor;
                ctx.shadowBlur = 6;
                ctx.fill();
                ctx.shadowBlur = 0;

                if (
                    hoverX !== null &&
                    Math.hypot(pt.x - hoverX, pt.y - hoverY) < 8
                ) {
                    hovered = pt;
                }
            });

            // === ü™ß Tooltip ===================
            if (hovered) {
                const d = new Date(hovered.date);
                const dateStr = d.toLocaleDateString("en-US", {
                    year: "numeric",
                    month: "2-digit",
                    day: "2-digit"
                });
                const fameStr = hovered.fame.toLocaleString();

                const tooltipLines = [`${dateStr}`, `Fame: ${fameStr}`];

                ctx.font = tooltipFont;
                ctx.textBaseline = "top";
                ctx.textAlign = "left";

                const padding = 6;
                const lineHeight = 18;
                const width = Math.max(...tooltipLines.map(t => ctx.measureText(t).width));
                const height = tooltipLines.length * lineHeight;

                let boxX = hovered.x + 10; // Í∏∞Î≥∏: Ïò§Î•∏Ï™ΩÏóê ÌëúÏãú
                const boxY = hovered.y - height - 10;

                // ‚úÖ Ï∫îÎ≤ÑÏä§Î•º Î≤óÏñ¥ÎÇòÎ©¥ ÏôºÏ™ΩÏúºÎ°ú Ìà¥ÌåÅ Ïù¥Îèô
                if (boxX + width + padding * 2 > canvas.width) {
                    boxX = hovered.x - (width + padding * 2) - 10;
                }

                // Î∞∞Í≤Ω
                ctx.fillStyle = tooltipBg;
                ctx.fillRect(boxX, boxY, width + padding * 2, height + padding);

                // ÌÖåÎëêÎ¶¨
                ctx.strokeStyle = tooltipBorder;
                ctx.strokeRect(boxX, boxY, width + padding * 2, height + padding);

                // ÌÖçÏä§Ìä∏
                ctx.fillStyle = textColor;
                ctx.textAlign = "left";
                tooltipLines.forEach((line, i) => {
                    ctx.fillText(line, boxX + padding, boxY + padding + i * lineHeight);
                });
            }
        }

        const SET_CATEGORIES = [
            "Dragon", "Magic", "Alpha", "Shadow", "Ethereal", "Valkyrie",
            "Nature", "Fairy", "Energy", "Serendipity", "Cleansing", "Gold"
        ];

        function getSetIconPath(setName) {
            for (const keyword of SET_CATEGORIES) {
                if (setName.includes(keyword)) {
                    return `assets/sets/${keyword}.png`;
                }
            }
            return "assets/sets/Unknown.png"; // fallback ÏïÑÏù¥ÏΩò
        }
        function getFusionIconPath(upgradeInfo) {
            if (!upgradeInfo) return null;

            const rarity = upgradeInfo.itemRarity;
            const itemName = upgradeInfo.itemName;
            const setName = upgradeInfo.setItemName;

            const distKeywords = ["Elegance", "Desire", "Betrayal"];
            for (const word of distKeywords) {
                if (itemName.includes(word)) {
                    return `assets/sets/${rarity}/Dist.png`;
                }
            }

            for (const keyword of SET_CATEGORIES) {
                if (setName.includes(keyword)) {
                    return `assets/sets/${rarity}/${keyword}.png`;
                }
            }

            return `assets/sets/${rarity}/Unknown.png`;
        }

        function renderSetItems(setItems) {
            const container = document.getElementById("set-info-container");
            container.innerHTML = "";

            // ‚úÖ Í≥†Ï†ï Ïä§ÌÉÄÏùº
            container.style.width = "492px";
            container.style.margin = "0 auto";
            container.style.marginTop = "28px";
            container.style.display = "flex";
            container.style.flexDirection = "column";
            container.style.alignItems = "center";
            container.style.backgroundColor = "#1a1a1a";
            container.style.borderRadius = "8px";
            container.style.padding = "16px 20px";
            container.style.boxShadow = "0 0 12px rgba(0, 0, 0, 0.5)";
            container.style.boxSizing = "border-box";

            const rarityColors = {
                "Rare": "#B36BFF",
                "Unique": "#FF00FF",
                "Legendary": "#FF7800",
                "Epic": "#FFB400"
            };

            setItems.forEach(item => {
                const iconPath = getSetIconPath(item.setItemName);

                const wrapper = document.createElement("div");
                wrapper.style.display = "flex";
                wrapper.style.flexDirection = "column";
                wrapper.style.alignItems = "center";
                wrapper.style.fontFamily = "'Noto Sans', sans-serif";

                // ‚úÖ ÏÑ∏Ìä∏Î™Ö
                const name = document.createElement("div");
                name.textContent = item.setItemName;
                name.style.fontSize = "28px";
                name.style.fontWeight = "700";
                name.style.marginTop = "12px";
                name.style.marginBottom = "2px";
                name.style.color = "#eee";

                // ‚úÖ ÏïÑÏù¥ÏΩò + Îì±Í∏â
                const bottomRow = document.createElement("div");
                bottomRow.style.display = "flex";
                bottomRow.style.alignItems = "center";

                // ‚úÖ ÏÑ∏Ìä∏ Ìè¨Ïù∏Ìä∏
                const setPoint = document.createElement("div");
                setPoint.textContent = `(${item.active?.setPoint?.current ?? 0})`;
                setPoint.style.fontSize = "16px";
                setPoint.style.color = "#aaa";
                setPoint.style.marginTop = "0px";
                setPoint.style.marginBottom = "8px";
                setPoint.style.lineHeight = "1";

                const icon = document.createElement("img");
                icon.src = iconPath;
                icon.alt = item.setItemName;
                icon.style.display = "block"; // ÏõêÎ≥∏ ÌÅ¨Í∏∞ Ïú†ÏßÄ
                icon.style.marginRight = "8px";

                const rarity = document.createElement("span");
                rarity.textContent = item.setItemRarityName;
                rarity.style.fontSize = "24px";
                rarity.style.fontWeight = "600";
                rarity.style.paddingTop = "12px";
                rarity.style.paddingBottom = "12px";

                if (item.setItemRarityName === "Primeval") {
                    rarity.style.background = "linear-gradient(to bottom, #57e95b, #3a8390)";
                    rarity.style.webkitBackgroundClip = "text";
                    rarity.style.webkitTextFillColor = "transparent";
                } else {
                    let rarityColor = "#aaa"; // Í∏∞Î≥∏Í∞í
                    for (const key in rarityColors) {
                        if (item.setItemRarityName.includes(key)) {
                            rarityColor = rarityColors[key];
                            break;
                        }
                    }
                    rarity.style.color = rarityColor;
                }

                const iconWrapper = document.createElement("div");
                iconWrapper.style.position = "relative";
                iconWrapper.appendChild(icon);

                bottomRow.appendChild(iconWrapper);
                bottomRow.appendChild(rarity);

                wrapper.appendChild(name);
                wrapper.appendChild(bottomRow);
                wrapper.appendChild(setPoint);
                container.appendChild(wrapper);
            });
        }

        const fameCache = {};
        async function getItemFame(itemId) {
            if (!itemId) return null;
            if (fameCache[itemId]) return fameCache[itemId];
            try {
                const res = await fetch(`http://localhost:5000/item-fame/${itemId}`);
                if (!res.ok) throw new Error("Item API error");
                const data = await res.json();
                const fame = data.fame || null;
                fameCache[itemId] = fame;
                return fame;
            } catch (e) {
                console.warn("Failed to fetch fame for", itemId);
                return null;
            }
        }


        async function renderHistoryPanel(profile) {
            const { serverId, adventureName, characterId } = profile;
            const historyPanel = document.getElementById("history-section");
            historyPanel.innerHTML = ""; // Ï¥àÍ∏∞Ìôî

            const historyPath = `/datas/${serverId}/${adventureName}/${characterId}/history.json`;
            console.log("üìÅ Trying to fetch:", historyPath); // ‚úÖ Í≤ΩÎ°ú ÌôïÏù∏ Î°úÍ∑∏

            let history = [];
            try {
                const res = await fetch(historyPath);
                if (!res.ok) throw new Error("Failed to fetch history.json");
                history = await res.json();
            } catch (e) {
                console.error("Failed to load history:", e);
                historyPanel.innerHTML = "<div style='color:#888;text-align:center;'>No history data available</div>";
                return;
            }

            const iconSize = 28 * SCALE;
            const historyItemHeight = 69 * SCALE;
            const spacing = 12;

            for (const entry of history.reverse()) {
                const row = document.createElement("div");
                row.style.position = "relative";
                row.style.width = `${426 * SCALE}px`;
                row.style.height = `${historyItemHeight}px`;
                row.style.marginBottom = `${spacing}px`;
                row.style.background = `url('assets/image/history.png') no-repeat center/contain`;
                row.style.borderRadius = "8px";
                row.style.boxShadow = "0 2px 6px rgba(0,0,0,0.4)";
                row.style.display = "flex";
                row.style.alignItems = "center";
                row.style.justifyContent = "space-between";
                row.style.padding = `0 ${16 * SCALE}px`;

                // ÎÇ†Ïßú ÌÖçÏä§Ìä∏
                const dateLabel = document.createElement("div");
                dateLabel.innerText = entry.date;
                dateLabel.style.position = "absolute";
                dateLabel.style.top = `${6 * SCALE}px`;
                dateLabel.style.left = "50%";
                dateLabel.style.transform = "translateX(-50%)";
                dateLabel.style.fontSize = `${10 * SCALE}px`;
                dateLabel.style.color = "#ccc";
                dateLabel.style.fontWeight = "bold";
                row.appendChild(dateLabel);

                for (let i = 0; i < entry.before.length; i++) {
                    const b = entry.before[i];
                    const a = entry.after[i];

                    const fameBefore = await getItemFame(b.itemId);
                    const fameAfter = await getItemFame(a.itemId);

                    if(b.itemId != null) {
                        const leftImg = document.createElement("img");
                        leftImg.src = `https://img-api.dfoneople.com/df/items/${b.itemId}`;
                        leftImg.style.width = `${iconSize}px`;
                        leftImg.style.height = `${iconSize}px`;
                        row.appendChild(leftImg);
                    }

                    const rightWrapper = document.createElement("div");
                    rightWrapper.style.position = "relative";

                    if(a.itemId != null) {
                        const rightImg = document.createElement("img");
                        rightImg.src = `https://img-api.dfoneople.com/df/items/${a.itemId}`;
                        rightImg.style.width = `${iconSize}px`;
                        rightImg.style.height = `${iconSize}px`;
                        rightWrapper.appendChild(rightImg);
                    }

                    // ‚¨ÜÔ∏è or ‚¨áÔ∏è ÏïÑÏù¥ÏΩò
                    if (fameBefore != null && fameAfter != null && fameBefore !== fameAfter) {
                        const changeImg = document.createElement("img");
                        changeImg.src = fameAfter > fameBefore ? "assets/image/up.png" : "assets/image/down.png";
                        changeImg.style.position = "absolute";
                        changeImg.style.left = "0";
                        changeImg.style.bottom = "0";
                        changeImg.style.width = `${28 * SCALE}px`;
                        changeImg.style.height = `${13 * SCALE}px`;
                        rightWrapper.appendChild(changeImg);
                    }

                    row.appendChild(rightWrapper);
                }

                historyPanel.appendChild(row);
            }
        }



        async function renderCharacterDetail(profile, equipmentList) {
            document.getElementById("main-view").style.display = "none";
            const detailView = document.getElementById("detail-view");
            detailView.style.display = "block";

            const canvasWidth = 246 * SCALE;
            const canvasHeight = 177 * SCALE;
            const spriteHeight = 250 * SCALE * 0.75;
            const iconSize = 28 * SCALE;
            const tuneSize = [8 * SCALE, 10 * SCALE];

            detailView.innerHTML = `
    <button onclick="goBack()" style="margin:10px;padding:6px 12px;font-weight:bold;">‚Üê Back</button>
    <div style="display: flex; justify-content: center; gap: 32px;">
        <!-- ÏôºÏ™Ω Ï∫êÎ¶≠ÌÑ∞ ÏòÅÏó≠ -->
        <div class="character-center-wrapper" style="display: flex; flex-direction: column; align-items: center;">
            <div class="character-canvas" style="width:${canvasWidth}px;height:${canvasHeight}px;position:relative;">
                <img class="background" src="assets/image/background.png" alt="Background" style="width:100%;height:100%;position:absolute;z-index:0;border-radius:8px;">
                <img class="character-sprite" src="assets/characters/${profile.jobName}.png"
                    style="position:absolute;bottom:0;left:50%;transform:translateX(-50%);
                        height:${spriteHeight}px;z-index:1;" />
                <div class="equipment-layer" id="equipment-layer" style="position:absolute;width:100%;height:100%;z-index:2;"></div>
            </div>

            <div id="set-info-container"
                style="margin-top: 28px; display: flex; flex-direction: column; align-items: center; padding: 4px 8px; min-height: 20px;">
            </div>

            <canvas id="fame-chart" width="${canvasWidth}" height="${canvasHeight * 0.75}"></canvas>
        </div>

        <!-- Ïò§Î•∏Ï™Ω ÌûàÏä§ÌÜ†Î¶¨ Ìå®ÎÑê -->
        <div id="history-panel"
            style="width:${canvasWidth}px; background:#222; border-radius:8px; padding:16px; color:#ccc; font-family:'Noto Sans KR', sans-serif; box-shadow:0 0 6px rgba(0,0,0,0.5);">
            [Gear History Area]
        </div>
    </div>

    <div class="character-detail">
        <div class="bottom-left"></div>
        <div class="bottom-right"></div>
    </div>
    `;

            const eqLayer = document.getElementById("equipment-layer");

            equipmentList.forEach(eq => {
                const slotKey = normalizeSlot(eq.slotName || eq.slotId);
                const [x, y] = SLOT_POSITION[slotKey] || [0, 0];

                const container = document.createElement("div");
                container.style.position = "absolute";
                container.style.left = `${x * SCALE}px`;
                container.style.top = `${y * SCALE}px`;
                container.style.width = `${iconSize}px`;
                container.style.height = `${iconSize}px`;
                if (slotKey === "SecondaryWeapon") {
                    container.style.transform = "scale(0.5)";
                    container.style.transformOrigin = "top left";
                }

                const img = document.createElement("img");
                img.src = `https://img-api.dfoneople.com/df/items/${eq.itemId}`;
                img.style.width = "100%";
                img.style.height = "100%";
                img.style.position = "absolute";
                img.style.left = "0";
                img.style.top = "0";
                img.style.zIndex = "2";
                container.appendChild(img);

                // ‚úÖ ÏúµÌï©ÏÑù ÏïÑÏù¥ÏΩò Ï∂îÍ∞Ä
                if (eq.upgradeInfo) {
                    const { itemName, itemRarity: fusionRarity, setItemName } = eq.upgradeInfo;
                    const baseRarity = eq.itemRarity;

                    if (setItemName) {
                        // ‚úÖ ÏÑ∏Ìä∏ ÏúµÌï©ÏÑù Ï≤òÎ¶¨
                        const keywordMatch = SET_CATEGORIES.find(k => setItemName.includes(k));
                        const fusionKeyword = keywordMatch || "Unknown";

                        const fusionIcon = document.createElement("img");
                        fusionIcon.src = `assets/sets/${fusionRarity}/${fusionKeyword}.png`;
                        fusionIcon.alt = "Fusion";
                        fusionIcon.style.position = "absolute";

                        const fusionW = 27 * SCALE * 0.75;
                        const fusionH = 12 * SCALE * 0.75;
                        fusionIcon.style.width = `${fusionW}px`;
                        fusionIcon.style.height = `${fusionH}px`;
                        fusionIcon.style.right = "0";
                        fusionIcon.style.top = "0";
                        fusionIcon.style.zIndex = "4";
                        container.appendChild(fusionIcon);

                    } else if (/Elegance|Desire|Betrayal/.test(itemName)) {
                        // ‚úÖ Dist ÏúµÌï©ÏÑù Ï≤òÎ¶¨
                        const fusionIcon = document.createElement("img");
                        fusionIcon.src = `assets/sets/${fusionRarity}/Dist.png`;
                        fusionIcon.alt = "Fusion";
                        fusionIcon.style.position = "absolute";

                        const fusionW = 27 * SCALE * 0.75;
                        const fusionH = 12 * SCALE * 0.75;
                        fusionIcon.style.width = `${fusionW}px`;
                        fusionIcon.style.height = `${fusionH}px`;
                        fusionIcon.style.right = "0";
                        fusionIcon.style.top = "0";
                        fusionIcon.style.zIndex = "4";
                        container.appendChild(fusionIcon);

                    } else {
                        // ‚úÖ ÏùºÎ∞ò ÏúµÌï©ÏÑù Ï≤òÎ¶¨: Base + Core
                        const fusionWrapper = document.createElement("div");
                        fusionWrapper.style.position = "absolute";
                        fusionWrapper.style.right = "0";
                        fusionWrapper.style.top = "0";
                        fusionWrapper.style.width = `${28 * SCALE * 0.75}px`;
                        fusionWrapper.style.height = `${13 * SCALE * 0.75}px`;
                        fusionWrapper.style.zIndex = "4";

                        const baseImg = document.createElement("img");
                        baseImg.src = `assets/fusions/${baseRarity}/Base.png`;
                        baseImg.style.width = "100%";
                        baseImg.style.height = "100%";
                        baseImg.style.position = "absolute";
                        baseImg.style.left = "0";
                        baseImg.style.top = "0";

                        const coreImg = document.createElement("img");
                        coreImg.src = `assets/fusions/${fusionRarity}/Core.png`;
                        coreImg.style.width = "100%";
                        coreImg.style.height = "100%";
                        coreImg.style.position = "absolute";
                        coreImg.style.left = "0";
                        coreImg.style.top = "0";

                        fusionWrapper.appendChild(baseImg);
                        fusionWrapper.appendChild(coreImg);
                        container.appendChild(fusionWrapper);
                    }
                }



                // ‚úÖ Ï°∞Ïú® ÏïÑÏù¥ÏΩò
                const tuneLevel = eq.tune?.level || 0;
                if (tuneLevel >= 1 && tuneLevel <= 3) {
                    const tuneImg = document.createElement("img");
                    tuneImg.src = `assets/equipments/etc/tune${tuneLevel}.png`;
                    tuneImg.style.position = "absolute";
                    tuneImg.style.width = `${tuneSize[0]}px`;
                    tuneImg.style.height = `${tuneSize[1]}px`;
                    tuneImg.style.left = `${iconSize - tuneSize[0] - 1}px`;
                    tuneImg.style.top = `${iconSize - tuneSize[1]}px`;
                    tuneImg.style.zIndex = "3";
                    container.appendChild(tuneImg);
                }

                eqLayer.appendChild(container);
            });

            // Í∞ïÌôî ÏàòÏπò Ï∫îÎ≤ÑÏä§
            const reinforceCanvas = document.createElement("canvas");
            reinforceCanvas.width = canvasWidth;
            reinforceCanvas.height = canvasHeight;
            reinforceCanvas.style.position = "absolute";
            reinforceCanvas.style.left = "0";
            reinforceCanvas.style.top = "0";
            reinforceCanvas.style.zIndex = "5";

            document.querySelector(".character-canvas").appendChild(reinforceCanvas);

            const rctx = reinforceCanvas.getContext("2d");
            rctx.font = `${9 * SCALE}px gulim, sans-serif`;
            rctx.textBaseline = "top";
            rctx.textAlign = "left";

            function drawReinforceText(x, y, text, color, scaleFactor = 1) {
                const fontSize = Math.floor(9 * SCALE * scaleFactor);
                rctx.font = `${fontSize}px gulim, sans-serif`;
                rctx.lineWidth = 4 * scaleFactor;
                rctx.strokeStyle = "black";
                rctx.strokeText(text, x, y);
                rctx.fillStyle = color;
                rctx.fillText(text, x, y);
            }

            equipmentList.forEach(eq => {
                const slotKey = normalizeSlot(eq.slotName || eq.slotId);
                const [baseX, baseY] = SLOT_POSITION[slotKey] || [0, 0];
                const reinforce = eq.reinforce || 0;
                const isAmp = eq.amplificationName != null;
                const reinforceColor = isAmp ? "#FF00FF" : "#68D5ED";

                if (slotKey !== "Title" && (reinforce > 0 || isAmp)) {
                    const scaleFactor = (slotKey === "SecondaryWeapon") ? 0.75 : 1;
                    const x = baseX * SCALE;
                    const y = baseY * SCALE;
                    drawReinforceText(x, y, `+${reinforce}`, reinforceColor, scaleFactor);
                }
            });

            const textCanvas = document.createElement("canvas");
            textCanvas.width = canvasWidth;
            textCanvas.height = canvasHeight;
            textCanvas.style.position = "absolute";
            textCanvas.style.left = "0";
            textCanvas.style.top = "0";
            textCanvas.style.zIndex = "4";

            const ctx = textCanvas.getContext("2d");
            document.querySelector(".character-canvas").appendChild(textCanvas);

            drawCharacterText(ctx, profile);

            const fameRes = await fetch(`${API_ROOT}/fame-history`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ server: profile.serverId, characterName: profile.characterName })
            });
            if (fameRes.ok) {
                const fameData = await fameRes.json();
                const records = fameData.records;

                await document.fonts.load('10px "Noto Sans KR"');
                renderFameChart(records);

                const canvas = document.getElementById("fame-chart");
                canvas.addEventListener("mousemove", (e) => {
                    const rect = canvas.getBoundingClientRect();
                    const mx = e.clientX - rect.left;
                    const my = e.clientY - rect.top;
                    renderFameChart(records, mx, my);
                });
                canvas.addEventListener("mouseleave", () => {
                    renderFameChart(records);
                });
            }
        }


        function goBack() {
            history.replaceState({}, '', '/');
            document.getElementById("detail-view").style.display = "none";
            document.getElementById("main-view").style.display = "flex";
        }

        document.querySelector('button').addEventListener('click', async function () {
            const serverSel = document.querySelector('select').value;
            const explorerName = document.querySelector('input').value.trim();
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = "";

            if (!explorerName) {
                alert("Please enter a name!");
                return;
            }

            if (serverSel === "All Servers") {
                resultsDiv.innerHTML = `<div style="color:#f66; font-weight:bold;">Please select a server.</div>`;
                return;
            }

            const serverId = serverToApiValue(serverSel);

            try {
                const res = await fetch(`${API_ROOT}/search`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ server: serverId, name: explorerName })
                });
                if (!res.ok) throw new Error("Not found");
                const data = await res.json();
                const profile = data.profile;

                resultsDiv.innerHTML = showCard(profile, explorerName);

                const cardElem = document.querySelector('.card');
                cardElem.addEventListener('click', async () => {
                    const urlParams = new URLSearchParams({ server: serverId, name: explorerName });
                    history.pushState({}, '', `?${urlParams.toString()}`);

                    const eqRes = await fetch(`${API_ROOT}/equipment`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ server: serverId, name: explorerName })
                    });
                    if (!eqRes.ok) throw new Error("Equipment error");
                    const eqData = await eqRes.json();

                    // ‚úÖ Ï†ÑÏ≤¥ Î†àÏù¥ÏïÑÏõÉÏùÑ Ïö∞Ï∏° ÌûàÏä§ÌÜ†Î¶¨ ÏòÅÏó≠ Ìè¨Ìï® Íµ¨Ï°∞Î°ú Íµ¨ÏÑ±
                    document.getElementById("main-view").style.display = "none";
                    const detailView = document.getElementById("detail-view");
                    detailView.style.display = "flex";
                    detailView.style.flexDirection = "row";
                    detailView.style.alignItems = "flex-start";
                    detailView.style.gap = "24px";

                    // ÏôºÏ™Ω Ï∫êÎ¶≠ÌÑ∞ ÏòÅÏó≠ Ï¥àÍ∏∞Ìôî
                    const charWrapper = document.createElement("div");
                    charWrapper.id = "character-section";
                    detailView.innerHTML = "";
                    detailView.appendChild(charWrapper);

                    // Ïò§Î•∏Ï™Ω ÌûàÏä§ÌÜ†Î¶¨ ÏòÅÏó≠ Ï∂îÍ∞Ä
                    const historySection = document.createElement("div");
                    historySection.id = "history-section";
                    historySection.style.width = `${246 * SCALE}px`;
                    historySection.style.height = `${(246 + 177) * SCALE}px`;
                    historySection.style.backgroundColor = "#222";  // ‚úÖ ÏãúÍ∞ÅÌôîÏö© ÏûÑÏãú Î∞∞Í≤Ω
                    historySection.style.border = "1px solid #444";
                    historySection.style.borderRadius = "8px";
                    historySection.style.boxSizing = "border-box";
                    historySection.style.padding = "12px";
                    historySection.innerHTML = `
    <div style="color:#888; text-align:center; font-weight:bold;">
        [Ïû•ÎπÑ Î≥ÄÍ≤Ω Ïù¥Î†• ÏòÅÏó≠]
    </div>
`;

                    detailView.appendChild(historySection);
                    await renderHistoryPanel(profile);

                    // ‚úÖ Í∞úÎ≥Ñ Íµ¨ÏÑ± ÏöîÏÜå Î†åÎçîÎßÅ
                    await renderCharacterDetail(profile, eqData.equipment.equipment); // Ï¢åÏ∏° Íµ¨ÏÑ±
                    await renderSetItems(eqData.equipment.setItemInfo);               // Ïö∞Ï∏° ÏÑ∏Ìä∏ Ï†ïÎ≥¥
                });
            } catch (e) {
                resultsDiv.innerHTML = `<div style="color:#f66; font-weight:bold;">Character info not found.</div>`;
            }
        });

        window.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const server = params.get('server');
            const name = params.get('name');

            if (server && name) {
                try {
                    const res = await fetch(`${API_ROOT}/search`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ server, name })
                    });
                    if (!res.ok) throw new Error("Not found");
                    const data = await res.json();
                    const profile = data.profile;

                    const eqRes = await fetch(`${API_ROOT}/equipment`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ server, name })
                    });
                    if (!eqRes.ok) throw new Error("Equipment error");
                    const eqData = await eqRes.json();

                    // ÎèôÏùºÌïú Ïö∞Ï∏° ÌûàÏä§ÌÜ†Î¶¨ Ìè¨Ìï® Î†àÏù¥ÏïÑÏõÉ Íµ¨ÏÑ±
                    document.getElementById("main-view").style.display = "none";
                    const detailView = document.getElementById("detail-view");
                    detailView.style.display = "flex";
                    detailView.style.flexDirection = "row";
                    detailView.style.alignItems = "flex-start";
                    detailView.style.gap = "24px";

                    const charWrapper = document.createElement("div");
                    charWrapper.id = "character-section";
                    detailView.innerHTML = "";
                    detailView.appendChild(charWrapper);

                    const historySection = document.createElement("div");
                    historySection.id = "history-section";
                    historySection.style.width = `${246 * SCALE}px`;
                    historySection.style.height = `${(246 + 177) * SCALE}px`;
                    historySection.style.backgroundColor = "#222";  // ‚úÖ ÏãúÍ∞ÅÌôîÏö© ÏûÑÏãú Î∞∞Í≤Ω
                    historySection.style.border = "1px solid #444";
                    historySection.style.borderRadius = "8px";
                    historySection.style.boxSizing = "border-box";
                    historySection.style.padding = "12px";
                    historySection.innerHTML = `
    <div style="color:#888; text-align:center; font-weight:bold;">
        [Ïû•ÎπÑ Î≥ÄÍ≤Ω Ïù¥Î†• ÏòÅÏó≠]
    </div>
`;

                    detailView.appendChild(historySection);

                    await renderHistoryPanel(profile);
                    await renderCharacterDetail(profile, eqData.equipment.equipment);
                    await renderSetItems(eqData.equipment.setItemInfo);
                } catch (e) {
                    document.getElementById("detail-view").style.display = "block";
                    document.getElementById("main-view").style.display = "none";
                    document.getElementById("detail-view").innerHTML =
                        `<div style="color:#f66; padding:20px; font-weight:bold;">Character not found or failed to load.</div>`;
                }
            }
        });

    </script>

</body>

</html>